#!/bin/sh

#
# Work around bugs in mypy by filtering out false positive error messages.
#

set -e
set -u

tmp="$(mktemp -t mypy.XXXX)";

# Callable has no attribute "todo": because trial
# Cannot assign to a type: https://github.com/python/mypy/issues/1152

mypy "$@"                                                                     \
    | grep -v                                                                 \
        -e ": error: Cannot find module named 'arrow.[^']*'"                  \
        -e ": error: Cannot find module named 'git"                           \
        -e ": error: Cannot find module named 'hypothesis"                    \
        -e ": error: Cannot find module named 'hypothesis.[^']*'"             \
        -e ": error: Cannot find module named 'twisted.[^']*'"                \
        -e ": error: Module 'ssl' has no attribute 'Options'"                 \
        -e ": error: No library stub file for "                               \
        -e ': error: "Callable\[\[[^\]\+\], None\]" has no attribute "todo"'  \
        -e ': error: Cannot assign to a type'                                 \
        -e ': note: '                                                         \
        > "${tmp}" || true;

sort < "${tmp}";

if grep -e ": error: " "${tmp}" > /dev/null; then
  exit 1;
fi;
